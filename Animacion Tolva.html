<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Automatización: Carga por Peso (DC 5V)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #0f172a; /* Slate 900 */
            color: white;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        canvas {
            display: block;
            background: radial-gradient(circle at center, #1e293b 0%, #0f172a 100%);
        }
        .controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(15, 23, 42, 0.95);
            padding: 20px 30px;
            border-radius: 16px;
            border: 1px solid #334155;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
            display: flex;
            gap: 30px;
            align-items: flex-end;
            backdrop-filter: blur(8px);
            z-index: 10;
        }
        .panel-column {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .lcd-display {
            background-color: #0c0a09; /* Darker panel */
            border: 2px solid #475569;
            border-radius: 6px;
            padding: 10px;
            font-family: 'Courier New', monospace;
            min-width: 180px;
        }
        .lcd-row {
            display: flex;
            justify-content: space-between;
            color: #22c55e;
            font-size: 0.9rem;
            margin-bottom: 4px;
        }
        .lcd-value {
            font-weight: bold;
            color: #4ade80;
        }
        .lcd-label {
            color: #94a3b8;
        }
        
        button {
            padding: 12px 24px;
            background-color: #3b82f6;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            font-size: 0.85rem;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.3);
            white-space: nowrap;
        }
        button:hover { background-color: #2563eb; transform: translateY(-2px); }
        button:active { transform: translateY(0); }
        
        button.stop { background-color: #64748b; }
        button.stop:hover { background-color: #475569; }

        button.record { background-color: #ef4444; }
        button.record:hover { background-color: #dc2626; }
        button.record.recording { background-color: #991b1b; animation: pulse 1.5s infinite; }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(220, 38, 38, 0); }
            100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0); }
        }

        /* Indicadores LED físicos en UI */
        .indicators {
            display: flex;
            gap: 15px;
            margin-top: 5px;
        }
        .indicator-box {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }
        .led {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background-color: #334155;
            border: 2px solid #1e293b;
            transition: background-color 0.2s;
        }
        .led.on { background-color: #22c55e; box-shadow: 0 0 10px #22c55e; }
        .led.motor-on { background-color: #eab308; box-shadow: 0 0 10px #eab308; }
        .label-small { font-size: 0.7rem; color: #94a3b8; font-weight: bold; }

    </style>
</head>
<body>

    <canvas id="simCanvas"></canvas>

    <div class="controls">
        <!-- Columna 1: Panel HMI y LEDs -->
        <div class="panel-column">
            <div class="label-small" style="margin-bottom: -5px;">HMI - CONTROL</div>
            <div class="lcd-display">
                <div class="lcd-row">
                    <span class="lcd-label">ESTADO:</span>
                    <span id="statusText" class="lcd-value">INICIO</span>
                </div>
                <div class="lcd-row">
                    <span class="lcd-label">PESO (SP):</span>
                    <span class="lcd-value">500 g</span>
                </div>
                <div class="lcd-row">
                    <span class="lcd-label">PESO (PV):</span>
                    <span id="weightText" class="lcd-value" style="color: #fbbf24;">0 g</span>
                </div>
            </div>
            
            <!-- Indicadores LED -->
            <div class="indicators">
                <div class="indicator-box">
                    <div id="ledMotor" class="led"></div>
                    <span class="label-small">MOTOR</span>
                </div>
                <div class="indicator-box">
                    <div id="ledCell" class="led"></div>
                    <span class="label-small">BÁSCULA</span>
                </div>
                <div class="indicator-box">
                    <div id="ledRun" class="led on"></div>
                    <span class="label-small">AUTO</span>
                </div>
            </div>
        </div>

        <!-- Columna 2: Botonera -->
        <div class="panel-column" style="justify-content: flex-end; gap: 10px;">
            <button id="recordBtn" class="record">● REC VIDEO</button>
            <button id="resetBtn" class="stop">Reiniciar</button>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('simCanvas');
        const ctx = canvas.getContext('2d');

        // Referencias UI
        const ui = {
            status: document.getElementById('statusText'),
            weight: document.getElementById('weightText'),
            ledMotor: document.getElementById('ledMotor'),
            ledCell: document.getElementById('ledCell'),
            ledRun: document.getElementById('ledRun')
        };

        // Configuración Física
        const config = {
            beltY: 0,           
            hopperX: 0,         
            beltSpeed: 0,
            maxSpeed: 8,
            targetWeight: 500,  
            flowRate: 0,        
            gravity: 0.6,
            particleWeight: 4   
        };

        // Estado del Sistema
        let systemState = 'START';
        let particles = [];
        let cups = [];
        let beltOffset = 0;
        let motorAngle = 0;

        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            config.beltY = canvas.height * 0.75;
            config.hopperX = canvas.width * 0.5;
        }
        window.addEventListener('resize', resize);
        resize();

        // --- CLASES ---

        class Cup {
            constructor() {
                this.w = 110;
                this.h = 100;
                this.x = -150;
                this.y = config.beltY - this.h - 5;
                this.currentWeight = 0;
                this.color = '#cbd5e1';
            }

            update() {
                if (config.beltSpeed > 0) this.x += config.beltSpeed;
            }

            draw() {
                ctx.save();
                ctx.fillStyle = 'rgba(255, 255, 255, 0.15)';
                ctx.strokeStyle = '#94a3b8';
                ctx.lineWidth = 4;
                ctx.beginPath();
                ctx.moveTo(this.x, this.y); 
                ctx.lineTo(this.x + this.w, this.y); 
                ctx.lineTo(this.x + this.w - 15, this.y + this.h); 
                ctx.lineTo(this.x + 15, this.y + this.h); 
                ctx.closePath();
                ctx.fill();
                ctx.stroke();

                if (this.currentWeight > 0) {
                    const fillPct = Math.min(1, this.currentWeight / config.targetWeight);
                    const fillHeight = fillPct * (this.h - 10);
                    ctx.fillStyle = '#eab308';
                    ctx.beginPath();
                    ctx.moveTo(this.x + 15, this.y + this.h - 3);
                    ctx.lineTo(this.x + this.w - 15, this.y + this.h - 3);
                    ctx.lineTo(this.x + this.w - 15 - (1-fillPct)*5, (this.y + this.h) - fillHeight);
                    ctx.lineTo(this.x + 15 + (1-fillPct)*5, (this.y + this.h) - fillHeight);
                    ctx.fill();
                }
                
                if (this.currentWeight > 0) {
                    ctx.fillStyle = '#ffffff';
                    ctx.font = '12px monospace';
                    ctx.textAlign = 'center';
                    ctx.fillText(`${Math.floor(this.currentWeight)}g`, this.x + this.w/2, this.y - 10);
                }
                ctx.restore();
            }
        }

        class Particle {
            constructor() {
                this.x = config.hopperX + (Math.random() * 40 - 20);
                this.y = config.beltY - 180; 
                this.vx = (Math.random() - 0.5) * 1.5;
                this.vy = 2; 
                this.size = 3 + Math.random() * 3;
                this.color = '#fbbf24';
                this.caught = false;
                this.cupRef = null;
                this.relX = 0;
                this.relY = 0;
            }

            update() {
                if (this.caught && this.cupRef) {
                    this.x = this.cupRef.x + this.relX;
                    this.y = this.cupRef.y + this.relY;
                    return true;
                }
                this.vy += config.gravity;
                this.y += this.vy;
                this.x += this.vx;

                for (let c of cups) {
                    if (this.y > c.y + 10 && this.y < c.y + c.h && 
                        this.x > c.x + 10 && this.x < c.x + c.w - 10) {
                        this.caught = true;
                        this.cupRef = c;
                        const fillLvl = Math.min(1, c.currentWeight / config.targetWeight);
                        const hOffset = c.h - (fillLvl * c.h) - (Math.random()*15); 
                        this.relX = this.x - c.x;
                        this.relY = Math.max(10, hOffset); 
                        c.currentWeight += config.particleWeight;
                        return false; 
                    }
                }
                if (this.y > config.beltY) return false;
                return true;
            }

            draw() {
                ctx.fillStyle = this.color;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI*2);
                ctx.fill();
            }
        }

        // --- LÓGICA DE AUTOMATIZACIÓN (PLC) ---

        function runPLC() {
            if (cups.length === 0 && systemState === 'START') {
                systemState = 'TRANSPORT_IN';
                let newCup = new Cup();
                newCup.x = -120;
                cups.push(newCup);
                ui.status.innerText = "ENTRANDO VASO";
                config.beltSpeed = config.maxSpeed;
            }

            if (cups.length > 0) {
                let cup = cups[0];
                let cupCenter = cup.x + cup.w/2;

                switch (systemState) {
                    case 'TRANSPORT_IN':
                        ui.status.innerText = "TRANSPORTE >>";
                        ui.status.style.color = "#4ade80";
                        config.beltSpeed = config.maxSpeed;
                        config.flowRate = 0;
                        if (Math.abs(cupCenter - config.hopperX) < 10) systemState = 'WEIGHING_READY';
                        break;

                    case 'WEIGHING_READY':
                        config.beltSpeed = 0;
                        cup.x = config.hopperX - cup.w/2; 
                        ui.status.innerText = "TARA / LISTO";
                        ui.status.style.color = "#fbbf24";
                        setTimeout(() => {
                            if(systemState === 'WEIGHING_READY') systemState = 'FILLING';
                        }, 500);
                        break;

                    case 'FILLING':
                        config.beltSpeed = 0;
                        ui.status.innerText = "CARGANDO...";
                        ui.status.style.color = "#eab308";
                        ui.ledCell.classList.add('on');
                        ui.ledMotor.classList.add('motor-on');
                        if (config.flowRate < 10) config.flowRate += 0.5;
                        ui.weight.innerText = Math.floor(cup.currentWeight) + " g";
                        if (cup.currentWeight >= config.targetWeight) systemState = 'FULL_CLOSE';
                        break;

                    case 'FULL_CLOSE':
                        ui.status.innerText = "CARGA COMPLETA";
                        ui.status.style.color = "#22c55e";
                        ui.ledCell.classList.remove('on');
                        if (config.flowRate > 0) {
                            config.flowRate -= 1; 
                            ui.ledMotor.classList.add('motor-on');
                        } else {
                            config.flowRate = 0;
                            ui.ledMotor.classList.remove('motor-on');
                            setTimeout(() => { systemState = 'TRANSPORT_OUT'; }, 500);
                        }
                        break;

                    case 'TRANSPORT_OUT':
                        ui.status.innerText = "SALIDA >>";
                        ui.status.style.color = "#60a5fa";
                        config.beltSpeed = config.maxSpeed;
                        if (cup.x > canvas.width) {
                            cups.shift();
                            systemState = 'START';
                            ui.weight.innerText = "0 g";
                        }
                        break;
                }
            }
        }

        // --- DIBUJADO DE MAQUINARIA ---

        function drawSystem() {
            const hX = config.hopperX;
            const hY = config.beltY - 180;

            // Celda de Carga
            ctx.fillStyle = '#334155';
            ctx.fillRect(hX - 40, config.beltY + 20, 80, 40); 
            ctx.fillStyle = '#0f172a';
            ctx.fillRect(hX - 30, config.beltY + 30, 60, 20); 
            
            ctx.font = '12px monospace';
            ctx.fillStyle = '#ef4444'; 
            let weightDisplay = cups.length > 0 && Math.abs((cups[0].x + cups[0].w/2) - hX) < 60 ? Math.floor(cups[0].currentWeight) : 0;
            ctx.textAlign = 'center';
            ctx.fillText(`${weightDisplay}g`, hX, config.beltY + 44);

            ctx.strokeStyle = '#1e293b';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.moveTo(hX, config.beltY + 60);
            ctx.lineTo(hX, canvas.height); 
            ctx.stroke();

            // Tolva
            ctx.fillStyle = '#ca8a04'; 
            ctx.beginPath();
            ctx.moveTo(hX - 70, hY - 120);
            ctx.lineTo(hX + 70, hY - 120);
            ctx.lineTo(hX + 25, hY);
            ctx.lineTo(hX - 25, hY);
            ctx.fill();

            // Mecanismo Puerta
            const openOffset = (config.flowRate / 10) * 40; 
            
            ctx.fillStyle = '#64748b';
            ctx.fillRect(hX - 30 + openOffset, hY, 60, 12);
            ctx.fillStyle = '#94a3b8';
            ctx.fillRect(hX - 30 + openOffset, hY - 8, 70, 6);

            // Motor
            const gearX = hX + 50;
            const gearY = hY - 15;
            
            ctx.fillStyle = '#475569';
            ctx.fillRect(gearX - 5, gearY - 30, 60, 60);

            ctx.fillStyle = '#1e293b'; 
            ctx.beginPath();
            ctx.arc(gearX + 25, gearY, 20, 0, Math.PI*2);
            ctx.fill();
            
            // Etiqueta Motor 5V
            ctx.fillStyle = '#94a3b8';
            ctx.font = 'bold 8px sans-serif';
            ctx.fillText("DC 5V", gearX + 25, gearY + 3);

            ctx.beginPath();
            ctx.arc(gearX + 25, gearY - 12, 4, 0, Math.PI*2);
            const isMotorActive = (systemState === 'FILLING' && config.flowRate < 10) || (systemState === 'FULL_CLOSE' && config.flowRate > 0);
            ctx.fillStyle = isMotorActive ? '#22c55e' : '#ef4444';
            ctx.fill();
            
            ctx.strokeStyle = '#94a3b8';
            ctx.lineWidth = 4;
            ctx.beginPath();
            ctx.moveTo(gearX + 5, gearY);
            ctx.lineTo(gearX - 10, gearY); 
            ctx.stroke();

            ctx.save();
            ctx.translate(gearX - 10, gearY);
            if (isMotorActive) motorAngle += 0.2;
            ctx.rotate(motorAngle);
            
            ctx.fillStyle = '#cbd5e1';
            ctx.beginPath();
            ctx.arc(0,0, 10, 0, Math.PI*2);
            ctx.fill();
            for(let i=0; i<6; i++) {
                ctx.rotate(Math.PI/3);
                ctx.fillRect(8, -3, 5, 6);
            }
            ctx.restore();
        }

        function drawBelt() {
            ctx.fillStyle = '#334155';
            ctx.fillRect(0, config.beltY, canvas.width, 25);
            
            beltOffset += config.beltSpeed;
            ctx.fillStyle = '#64748b';
            for(let i=0; i<canvas.width; i+=100) {
                ctx.beginPath();
                ctx.arc(i, config.beltY + 12, 8, 0, Math.PI*2);
                ctx.fill();
                
                ctx.strokeStyle = '#0f172a';
                ctx.beginPath();
                ctx.moveTo(i, config.beltY + 12);
                const rx = i + Math.cos(beltOffset * 0.1) * 8;
                const ry = (config.beltY + 12) + Math.sin(beltOffset * 0.1) * 8;
                ctx.lineTo(rx, ry);
                ctx.stroke();
            }
        }

        function loop() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            runPLC();
            drawSystem();
            drawBelt();
            cups.forEach(c => { c.update(); c.draw(); });
            if (config.flowRate > 0) {
                const count = Math.ceil(config.flowRate / 2);
                for(let i=0; i<count; i++) particles.push(new Particle());
            }
            particles = particles.filter(p => p.update());
            particles.forEach(p => p.draw());
            requestAnimationFrame(loop);
        }

        document.getElementById('resetBtn').addEventListener('click', () => {
            cups = [];
            particles = [];
            systemState = 'START';
            config.flowRate = 0;
            config.beltSpeed = 0;
            ui.weight.innerText = "0 g";
            ui.status.innerText = "REINICIADO";
        });

        const recordBtn = document.getElementById('recordBtn');
        let mediaRecorder;
        let recordedChunks = [];

        recordBtn.addEventListener('click', () => {
            if (recordBtn.classList.contains('recording')) return;
            recordBtn.classList.add('recording');
            recordBtn.innerText = "■ GRABANDO...";
            
            const stream = canvas.captureStream(30); 
            const mimeTypes = ['video/webm;codecs=vp9', 'video/webm;codecs=vp8', 'video/webm'];
            let selectedMime = mimeTypes.find(type => MediaRecorder.isTypeSupported(type)) || 'video/webm';

            try { mediaRecorder = new MediaRecorder(stream, { mimeType: selectedMime }); } 
            catch (e) { mediaRecorder = new MediaRecorder(stream); }

            recordedChunks = [];
            mediaRecorder.ondataavailable = (event) => { if (event.data.size > 0) recordedChunks.push(event.data); };
            mediaRecorder.onstop = () => {
                const blob = new Blob(recordedChunks, { type: 'video/webm' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none'; a.href = url; a.download = 'simulacion_5v.webm';
                document.body.appendChild(a); a.click();
                setTimeout(() => { document.body.removeChild(a); window.URL.revokeObjectURL(url); }, 100);
                recordBtn.classList.remove('recording'); recordBtn.innerText = "● REC VIDEO";
            };
            mediaRecorder.start();
            setTimeout(() => { if (mediaRecorder.state === 'recording') mediaRecorder.stop(); }, 15000);
        });

        loop();

    </script>
</body>
</html>
