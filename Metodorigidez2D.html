<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Análisis Estructural: Cercha 2 Barras</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- Configuración MathJax para mejor renderizado -->
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                macros: {
                    kN: "\\text{ kN}",
                    m: "\\text{ m}",
                    cm: "\\text{ cm}"
                }
            },
            svg: {
                fontCache: 'global'
            }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <style>
        .canvas-container {
            position: relative;
            width: 100%;
            height: 400px; /* Altura fija para escritorio */
            min-height: 300px; /* Altura mínima para móvil */
            background-color: #f8fafc;
            border-radius: 0.5rem;
            border: 2px solid #e2e8f0;
            overflow: hidden;
            box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.06);
        }
        canvas {
            width: 100%;
            height: 100%;
            display: block;
        }
        .step-content {
            display: none;
        }
        .step-content.active {
            display: block;
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* Ajustes para fórmulas matemáticas */
        .math-block {
            overflow-x: auto;
            padding: 0.5rem 0;
            margin: 0.5rem 0;
            /* Ocultar barra scroll fea pero permitir scroll */
            scrollbar-width: thin; 
            scrollbar-color: #cbd5e1 transparent;
        }
        .mjx-chtml {
            font-size: 110% !important; /* Ligeramente más grande */
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 font-sans h-screen flex flex-col">

    <!-- Header -->
    <header class="bg-indigo-900 text-white p-4 shadow-lg flex-none z-10">
        <div class="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center gap-2">
            <div>
                <h1 class="text-xl md:text-2xl font-bold flex items-center gap-2">
                    <i class="fas fa-cubes text-indigo-300"></i> Análisis Matricial
                </h1>
                <p class="text-xs md:text-sm text-indigo-200">Ejercicio Interactivo: Armadura de 2 Barras</p>
            </div>
            <div class="text-xs bg-indigo-800 px-3 py-1 rounded-full border border-indigo-700">
                Método de Rigidez
            </div>
        </div>
    </header>

    <main class="flex-1 max-w-7xl mx-auto p-2 md:p-6 w-full grid grid-cols-1 lg:grid-cols-2 gap-4 md:gap-6 overflow-hidden">
        
        <!-- Columna Izquierda: Visualización (Arriba en móvil) -->
        <div class="flex flex-col gap-4 order-1 h-full min-h-0">
            <div class="bg-white p-4 rounded-xl shadow-md border border-slate-200 flex flex-col h-full">
                
                <!-- Controles Superiores -->
                <div class="flex justify-between items-center mb-3 flex-none">
                    <h2 class="font-bold text-slate-700 flex items-center gap-2">
                        <i class="fas fa-eye text-blue-500"></i> Simulación
                    </h2>
                    <div class="flex items-center gap-3 bg-slate-50 px-3 py-1 rounded-lg border border-slate-200">
                        <label class="text-xs font-semibold text-slate-500 uppercase tracking-wider">Deformación:</label>
                        <input type="range" id="scaleSlider" min="1" max="100" value="50" class="w-24 accent-blue-600 cursor-pointer">
                    </div>
                </div>
                
                <!-- Lienzo -->
                <div class="canvas-container flex-1" id="canvasWrapper">
                    <canvas id="structureCanvas"></canvas>
                    <div id="forceLabel" class="absolute hidden bg-red-50 text-red-700 px-2 py-1 rounded shadow-sm border border-red-200 text-xs font-bold transform -translate-x-1/2 pointer-events-none">
                        100 kN
                    </div>
                </div>

                <!-- Controles Inferiores -->
                <div class="flex justify-center gap-3 mt-4 flex-none">
                    <button id="btnReset" class="px-5 py-2.5 bg-white text-slate-600 border border-slate-300 rounded-lg hover:bg-slate-50 hover:text-slate-800 transition shadow-sm font-medium text-sm flex items-center gap-2">
                        <i class="fas fa-undo-alt"></i> Reiniciar
                    </button>
                    <button id="btnAnimate" class="px-6 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 active:bg-blue-800 transition shadow-md font-bold text-sm flex items-center gap-2 ring-2 ring-blue-600 ring-offset-2">
                        <i class="fas fa-play"></i> Aplicar Carga
                    </button>
                </div>
                
                <div class="mt-3 text-center">
                     <span id="canvasInfo" class="text-xs text-slate-500 bg-slate-100 px-3 py-1 rounded-full">
                        Estructura en reposo
                     </span>
                </div>
            </div>
        </div>

        <!-- Columna Derecha: Teoría Paso a Paso (Abajo en móvil) -->
        <div class="flex flex-col gap-4 order-2 h-full min-h-0">
            <div class="bg-white p-1 rounded-xl shadow-md border border-slate-200 flex flex-col h-full overflow-hidden relative">
                
                <!-- Barra de Navegación de Pasos -->
                <div class="p-4 border-b border-slate-100 flex justify-between items-center bg-white z-10">
                    <div>
                        <span class="text-xs font-bold text-blue-600 uppercase tracking-wide">Paso <span id="stepNumber">0</span> de 5</span>
                        <h2 class="text-lg md:text-xl font-bold text-slate-800 leading-tight" id="stepTitle">Inicio</h2>
                    </div>
                    <div class="flex gap-2">
                        <button id="prevStep" class="w-10 h-10 rounded-full bg-slate-100 hover:bg-blue-50 text-slate-600 hover:text-blue-600 transition flex items-center justify-center disabled:opacity-30 disabled:cursor-not-allowed">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <button id="nextStep" class="w-10 h-10 rounded-full bg-blue-600 hover:bg-blue-700 text-white transition flex items-center justify-center shadow-md shadow-blue-200 disabled:opacity-30 disabled:cursor-not-allowed">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>

                <!-- Contenido Scrollable -->
                <div class="flex-1 overflow-y-auto p-5 custom-scrollbar bg-white">
                    
                    <!-- STEP 0: Intro -->
                    <div class="step-content active" data-step="0">
                        <div class="prose prose-sm max-w-none text-slate-600">
                            <p class="lead text-slate-800 font-medium">
                                Vamos a resolver una estructura clásica: una armadura simétrica cargada en el centro.
                            </p>
                            
                            <div class="bg-slate-50 p-4 rounded-lg border border-slate-200 my-4">
                                <h4 class="text-slate-800 font-bold mb-3 flex items-center gap-2">
                                    <i class="fas fa-database text-slate-400"></i> Datos del Problema
                                </h4>
                                <ul class="space-y-2 text-sm">
                                    <li class="flex justify-between border-b border-slate-200 pb-1">
                                        <span>Nodo 1 (Fijo):</span> <span class="font-mono font-bold text-slate-800">(0, 4) m</span>
                                    </li>
                                    <li class="flex justify-between border-b border-slate-200 pb-1">
                                        <span>Nodo 2 (Fijo):</span> <span class="font-mono font-bold text-slate-800">(6, 4) m</span>
                                    </li>
                                    <li class="flex justify-between border-b border-slate-200 pb-1">
                                        <span>Nodo 3 (Libre):</span> <span class="font-mono font-bold text-slate-800">(3, 0) m</span>
                                    </li>
                                    <li class="flex justify-between border-b border-slate-200 pb-1">
                                        <span>Carga $P$:</span> <span class="font-mono font-bold text-red-600">100 kN $\downarrow$</span>
                                    </li>
                                    <li class="flex justify-between">
                                        <span>Rigidez $EA$:</span> <span class="font-mono font-bold text-blue-600">20,000 kN</span>
                                    </li>
                                </ul>
                            </div>
                            
                            <p class="text-xs text-center text-slate-400 italic">
                                Usaremos el triángulo 3-4-5 para simplificar los cálculos trigonométricos.
                            </p>
                        </div>
                    </div>

                    <!-- STEP 1: Geometry -->
                    <div class="step-content" data-step="1">
                        <h3 class="font-bold text-slate-800 mb-3">1. Vectores y Cosenos Directores ($\lambda$)</h3>
                        <p class="text-sm text-slate-600 mb-4">
                            Calculamos las proyecciones y la longitud $L$ para cada barra. Definimos la dirección siempre hacia el nodo libre (3).
                        </p>
                        
                        <!-- Barra A -->
                        <div class="mb-6 border-l-4 border-blue-500 pl-4 bg-blue-50/50 py-2 rounded-r-lg">
                            <h4 class="font-bold text-blue-800 text-sm uppercase mb-2">Barra A (Nodo 1 $\to$ 3)</h4>
                            <div class="math-block text-sm">
                                $$
                                \begin{aligned}
                                \Delta x &= 3 - 0 = 3 \\
                                \Delta y &= 0 - 4 = -4 \\
                                L &= \sqrt{3^2 + (-4)^2} = \mathbf{5 \text{ m}}
                                \end{aligned}
                                $$
                            </div>
                            <div class="mt-2 text-sm text-blue-900 bg-blue-100 p-2 rounded inline-block w-full text-center">
                                Cosenos Directores: 
                                $\quad \lambda_x = \frac{3}{5} = \mathbf{0.6} \quad, \quad \lambda_y = \frac{-4}{5} = \mathbf{-0.8}$
                            </div>
                        </div>

                        <!-- Barra B -->
                        <div class="border-l-4 border-green-500 pl-4 bg-green-50/50 py-2 rounded-r-lg">
                            <h4 class="font-bold text-green-800 text-sm uppercase mb-2">Barra B (Nodo 2 $\to$ 3)</h4>
                            <div class="math-block text-sm">
                                $$
                                \begin{aligned}
                                \Delta x &= 3 - 6 = -3 \\
                                \Delta y &= 0 - 4 = -4 \\
                                L &= \mathbf{5 \text{ m}}
                                \end{aligned}
                                $$
                            </div>
                            <div class="mt-2 text-sm text-green-900 bg-green-100 p-2 rounded inline-block w-full text-center">
                                Cosenos Directores: 
                                $\quad \lambda_x = \frac{-3}{5} = \mathbf{-0.6} \quad, \quad \lambda_y = \mathbf{-0.8}$
                            </div>
                        </div>
                    </div>

                    <!-- STEP 2: Matrix K -->
                    <div class="step-content" data-step="2">
                        <h3 class="font-bold text-slate-800 mb-2">2. Matrices de Rigidez Locales</h3>
                        <div class="bg-yellow-50 p-3 rounded border border-yellow-200 text-sm mb-4">
                            <span class="font-bold text-yellow-800">Constante de Rigidez:</span>
                            $$ k_{eq} = \frac{EA}{L} = \frac{20000}{5} = \mathbf{4000 \text{ kN/m}} $$
                        </div>

                        <div class="space-y-6">
                            <!-- Matriz A -->
                            <div>
                                <div class="flex justify-between text-xs font-bold text-blue-600 uppercase mb-1">
                                    <span>Barra A</span>
                                    <span>Nodos [1, 3]</span>
                                </div>
                                <div class="math-block bg-white border border-slate-100 rounded shadow-sm p-2 text-xs md:text-sm">
                                    $$ [k_A] = 4000 \begin{bmatrix} 
                                    0.36 & -0.48 & -0.36 & 0.48 \\
                                    -0.48 & 0.64 & 0.48 & -0.64 \\
                                    -0.36 & 0.48 & \mathbf{0.36} & \mathbf{-0.48} \\
                                    0.48 & -0.64 & \mathbf{-0.48} & \mathbf{0.64} 
                                    \end{bmatrix} $$
                                </div>
                            </div>

                            <!-- Matriz B -->
                            <div>
                                <div class="flex justify-between text-xs font-bold text-green-600 uppercase mb-1">
                                    <span>Barra B</span>
                                    <span>Nodos [2, 3]</span>
                                </div>
                                <div class="math-block bg-white border border-slate-100 rounded shadow-sm p-2 text-xs md:text-sm">
                                    $$ [k_B] = 4000 \begin{bmatrix} 
                                    0.36 & 0.48 & -0.36 & -0.48 \\
                                    0.48 & 0.64 & -0.48 & -0.64 \\
                                    -0.36 & -0.48 & \mathbf{0.36} & \mathbf{0.48} \\
                                    -0.48 & -0.64 & \mathbf{0.48} & \mathbf{0.64} 
                                    \end{bmatrix} $$
                                </div>
                            </div>
                        </div>
                        <p class="text-xs text-slate-400 mt-2 text-center">
                            *Los términos en <span class="font-bold text-slate-600">negrita</span> corresponden al Nodo 3 (grados de libertad libres).
                        </p>
                    </div>

                    <!-- STEP 3: Assembly -->
                    <div class="step-content" data-step="3">
                        <h3 class="font-bold text-slate-800 mb-3">3. Ensamble de la Matriz Global</h3>
                        <p class="text-sm text-slate-600 mb-4">
                            Simplificamos el sistema eliminando las filas/columnas de los apoyos fijos (1 y 2). Solo nos queda la sub-matriz del <strong>Nodo 3</strong>.
                        </p>

                        <div class="bg-indigo-50 p-4 rounded-lg border border-indigo-100">
                            <h4 class="font-bold text-indigo-900 text-sm mb-3 text-center">Suma de Rigideces en Nodo 3 $(u_3, v_3)$</h4>
                            
                            <div class="math-block text-sm">
                                $$
                                \begin{aligned}
                                K_{11} &= k_{A(3,3)} + k_{B(3,3)} \\
                                       &= 4000(0.36 + 0.36) = \mathbf{2880} \\[8pt]
                                K_{22} &= k_{A(4,4)} + k_{B(4,4)} \\
                                       &= 4000(0.64 + 0.64) = \mathbf{5120} \\[8pt]
                                K_{12} &= k_{A(3,4)} + k_{B(3,4)} \\
                                       &= 4000(-0.48 + 0.48) = \mathbf{0}
                                \end{aligned}
                                $$
                            </div>
                        </div>
                        <div class="mt-3 flex items-start gap-2 text-xs text-slate-500 bg-white p-2 rounded border">
                            <i class="fas fa-lightbulb text-yellow-500 mt-0.5"></i>
                            <span>Nota: El término cruzado $K_{12}$ es cero. Esto indica que un desplazamiento vertical no provoca fuerza horizontal, algo esperado por la <strong>simetría</strong>.</span>
                        </div>
                    </div>

                    <!-- STEP 4: Solution -->
                    <div class="step-content" data-step="4">
                        <h3 class="font-bold text-slate-800 mb-3">4. Solución del Sistema</h3>
                        <p class="text-sm text-slate-600 mb-2">Resolvemos la ecuación fundamental: $[K] \{d\} = \{F\}$</p>
                        
                        <div class="math-block bg-white p-3 rounded shadow-sm border border-slate-200 mb-4 overflow-x-auto">
                            $$ 
                            \begin{bmatrix} 
                            2880 & 0 \\ 
                            0 & 5120 
                            \end{bmatrix} 
                            \begin{Bmatrix} u_3 \\ v_3 \end{Bmatrix} 
                            = 
                            \begin{Bmatrix} 0 \\ -100 \end{Bmatrix} 
                            $$
                        </div>

                        <div class="grid grid-cols-1 gap-3">
                            <div class="bg-slate-50 p-3 rounded border-l-4 border-slate-400">
                                <span class="text-xs font-bold text-slate-500 uppercase">Horizontal ($u_3$)</span>
                                <div class="math-block text-sm">
                                    $$ u_3 = \frac{0}{2880} = \mathbf{0 \text{ m}} $$
                                </div>
                            </div>
                            <div class="bg-green-50 p-3 rounded border-l-4 border-green-500">
                                <span class="text-xs font-bold text-green-700 uppercase">Vertical ($v_3$)</span>
                                <div class="math-block text-sm">
                                    $$ v_3 = \frac{-100}{5120} = \mathbf{-0.0195 \text{ m}} $$
                                </div>
                            </div>
                        </div>

                        <div class="mt-4 text-center bg-green-100 text-green-800 py-2 rounded font-bold text-sm">
                            El nodo desciende 1.95 cm
                        </div>
                    </div>

                     <!-- STEP 5: Forces -->
                     <div class="step-content" data-step="5">
                        <h3 class="font-bold text-slate-800 mb-3">5. Cálculo de Fuerzas Internas</h3>
                        <p class="text-sm text-slate-600 mb-2">Usamos la fórmula de recuperación para la Barra A ($u_1, v_1 = 0$):</p>
                        
                        <div class="math-block bg-slate-50 p-2 rounded border border-slate-200 text-xs md:text-sm">
                            $$ F_A = \frac{EA}{L} \begin{bmatrix} -\lambda_x & -\lambda_y & \lambda_x & \lambda_y \end{bmatrix} \begin{Bmatrix} 0 \\ 0 \\ u_3 \\ v_3 \end{Bmatrix} $$
                        </div>

                        <div class="mt-4 space-y-2 text-sm">
                            <p>Sustituyendo valores:</p>
                            <div class="math-block">
                                $$ 
                                \begin{aligned}
                                F_A &= 4000 \left[ (0.6)(0) + (-0.8)(-0.0195) \right] \\
                                F_A &= 4000 \left[ 0 + 0.0156 \right]
                                \end{aligned}
                                $$
                            </div>
                        </div>

                        <div class="bg-blue-600 text-white p-4 rounded-lg shadow mt-4 text-center">
                            <span class="block text-blue-200 text-xs uppercase font-bold mb-1">Resultado Final</span>
                            <div class="text-2xl font-bold">
                                $$ F_A = 62.4 \text{ kN} $$
                            </div>
                            <span class="text-sm font-medium">(Tracción)</span>
                        </div>
                        
                        <div class="mt-4 text-xs text-center text-slate-500">
                            Comprobación Estática: $\sum F_y = 2 \cdot F_A \cdot \sin(\alpha) \approx 100$
                        </div>
                    </div>

                </div>
                
                <!-- Progress Indicator -->
                <div class="p-4 bg-slate-50 border-t border-slate-200 flex justify-center gap-2">
                    <div class="w-full bg-slate-200 h-1.5 rounded-full overflow-hidden">
                        <div id="progressBar" class="bg-blue-600 h-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // --- CONSTANTS & CONFIG ---
        const canvas = document.getElementById('structureCanvas');
        const ctx = canvas.getContext('2d');
        const parent = document.getElementById('canvasWrapper');

        // Physical World Coords
        const node1 = { x: 0, y: 4, label: '1' };
        const node2 = { x: 6, y: 4, label: '2' };
        const node3Original = { x: 3, y: 0, label: '3' };
        
        // Calculated displacement (real values)
        const displacement = { u: 0, v: -0.01953125 }; 

        // Animation State
        let currentAnimFrame = 0;
        let isAnimating = false;
        let animProgress = 0; // 0 to 1
        let exaggeratedScale = 50; // Controlled by slider
        
        // Canvas Scaling
        let scale = 1;
        let offsetX = 0;
        let offsetY = 0;

        // Steps Logic
        let currentStep = 0;
        const totalSteps = 6;
        const stepsData = [
            { title: "Planteamiento", info: "Estructura inicial sin deformar." },
            { title: "1. Geometría", info: "Barras de 5m de longitud. Triángulo 3-4-5." },
            { title: "2. Matrices Locales", info: "Rigidez individual de cada elemento calculada." },
            { title: "3. Ensamble", info: "Suma de rigideces en el nodo común (3)." },
            { title: "4. Solución", info: "Cálculo de desplazamientos u3 y v3." },
            { title: "5. Fuerzas", info: "Cálculo de tensiones internas (62.4 kN)." }
        ];

        // --- RESIZE & COORD SYSTEM ---
        function resizeCanvas() {
            canvas.width = parent.clientWidth;
            canvas.height = parent.clientHeight;
            
            // Fit structure (width 6, height 4) into canvas with padding
            const padding = 40;
            const drawWidth = canvas.width - (padding * 2);
            const drawHeight = canvas.height - (padding * 2);
            
            // Determine scale (pixels per meter)
            const scaleX = drawWidth / 6; // Total width 6m
            const scaleY = drawHeight / 5; // Total height approx 5m
            scale = Math.min(scaleX, scaleY);
            
            // Centering
            offsetX = padding + (drawWidth - (6 * scale)) / 2;
            offsetY = padding + 4 * scale; 
        }

        function toCanvas(x, y) {
            // World Y is up, Canvas Y is down
            return {
                x: offsetX + x * scale,
                y: offsetY - y * scale 
            };
        }

        // --- DRAWING ---
        function drawStructure(progress) {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Calculate Node 3 position
            const visualDispV = displacement.v * exaggeratedScale * progress;
            const node3Current = {
                x: node3Original.x, 
                y: node3Original.y + visualDispV
            };

            const n1 = toCanvas(node1.x, node1.y);
            const n2 = toCanvas(node2.x, node2.y);
            const n3 = toCanvas(node3Current.x, node3Current.y);
            const n3Orig = toCanvas(node3Original.x, node3Original.y);

            // 1. Draw Ghost (Original Position) if deformed
            if (progress > 0) {
                ctx.beginPath();
                ctx.strokeStyle = '#cbd5e1';
                ctx.setLineDash([5, 5]);
                ctx.lineWidth = 2;
                ctx.moveTo(n1.x, n1.y);
                ctx.lineTo(n3Orig.x, n3Orig.y);
                ctx.lineTo(n2.x, n2.y);
                ctx.stroke();
                ctx.setLineDash([]);
            }

            // 2. Draw Members
            ctx.lineWidth = 6;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            
            // Bar A (Color logic)
            const colorA = (currentStep === 1 || currentStep === 2 || currentStep === 5) ? '#2563eb' : '#475569';
            ctx.strokeStyle = colorA;
            ctx.beginPath();
            ctx.moveTo(n1.x, n1.y);
            ctx.lineTo(n3.x, n3.y);
            ctx.stroke();

            // Bar B
            const colorB = (currentStep === 1 || currentStep === 2 || currentStep === 5) ? '#16a34a' : '#475569';
            ctx.strokeStyle = colorB;
            ctx.beginPath();
            ctx.moveTo(n2.x, n2.y);
            ctx.lineTo(n3.x, n3.y);
            ctx.stroke();

            // 3. Draw Supports
            drawSupport(n1.x, n1.y);
            drawSupport(n2.x, n2.y);

            // 4. Draw Nodes
            drawNode(n1.x, n1.y, '1');
            drawNode(n2.x, n2.y, '2');
            drawNode(n3.x, n3.y, '3');

            // 5. Draw Load
            const arrowLength = canvas.height * 0.15; 
            ctx.beginPath();
            ctx.strokeStyle = '#ef4444'; 
            ctx.fillStyle = '#ef4444';
            ctx.lineWidth = 4;
            ctx.moveTo(n3.x, n3.y);
            ctx.lineTo(n3.x, n3.y + arrowLength);
            ctx.stroke();
            
            ctx.beginPath();
            ctx.moveTo(n3.x, n3.y + arrowLength);
            ctx.lineTo(n3.x - 6, n3.y + arrowLength - 12);
            ctx.lineTo(n3.x + 6, n3.y + arrowLength - 12);
            ctx.fill();

            // Label Position
            const label = document.getElementById('forceLabel');
            label.style.display = 'block';
            label.style.left = n3.x + 'px';
            label.style.top = (n3.y + arrowLength + 10) + 'px';

            // 6. Draw Text Info
            if (progress > 0.1) {
                 ctx.fillStyle = '#166534';
                 ctx.font = 'bold 14px sans-serif';
                 const dyCm = (displacement.v * 100).toFixed(2);
                 ctx.fillText(`dy: ${dyCm} cm`, n3.x + 20, n3.y + 20);
            }
        }

        function drawSupport(x, y) {
            ctx.fillStyle = '#64748b';
            ctx.beginPath();
            ctx.moveTo(x, y);
            ctx.lineTo(x - 12, y - 24);
            ctx.lineTo(x + 12, y - 24);
            ctx.fill();
            
            ctx.beginPath();
            ctx.strokeStyle = '#94a3b8';
            ctx.lineWidth = 3;
            ctx.moveTo(x - 18, y - 24);
            ctx.lineTo(x + 18, y - 24);
            ctx.stroke();
        }

        function drawNode(x, y, label) {
            ctx.beginPath();
            ctx.arc(x, y, 9, 0, 2 * Math.PI);
            ctx.fillStyle = 'white';
            ctx.fill();
            ctx.strokeStyle = '#0f172a';
            ctx.lineWidth = 2.5;
            ctx.stroke();
            
            ctx.fillStyle = '#0f172a';
            ctx.font = 'bold 11px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(label, x, y);
        }

        // --- ANIMATION ---
        function animateDrop() {
            if(isAnimating) return;
            isAnimating = true;
            let start = null;
            const duration = 1500; 

            function step(timestamp) {
                if (!start) start = timestamp;
                const progress = Math.min((timestamp - start) / duration, 1);
                
                // Elastic ease out
                const p = 0.3;
                const elastic = Math.pow(2, -10 * progress) * Math.sin((progress - p / 4) * (2 * Math.PI) / p) + 1;
                
                animProgress = elastic;
                if (progress === 1) animProgress = 1;

                drawStructure(animProgress);

                if (progress < 1) {
                    window.requestAnimationFrame(step);
                } else {
                    isAnimating = false;
                }
            }
            window.requestAnimationFrame(step);
        }

        function resetAnimation() {
            animProgress = 0;
            isAnimating = false;
            drawStructure(0);
        }

        // --- UI LOGIC ---
        function updateStepUI() {
            document.getElementById('stepTitle').innerText = stepsData[currentStep].title;
            document.getElementById('stepNumber').innerText = currentStep;
            document.getElementById('canvasInfo').innerText = stepsData[currentStep].info;

            document.querySelectorAll('.step-content').forEach(el => el.classList.remove('active'));
            document.querySelector(`.step-content[data-step="${currentStep}"]`).classList.add('active');

            // Progress Bar
            const pct = (currentStep / (totalSteps - 1)) * 100;
            document.getElementById('progressBar').style.width = `${pct}%`;

            document.getElementById('prevStep').disabled = currentStep === 0;
            document.getElementById('nextStep').disabled = currentStep === totalSteps - 1;

            drawStructure(animProgress);
            
            // Force MathJax Typeset
            if (window.MathJax) {
                MathJax.typesetPromise();
            }
        }

        window.addEventListener('resize', () => {
            resizeCanvas();
            drawStructure(animProgress);
        });

        document.getElementById('btnAnimate').addEventListener('click', animateDrop);
        document.getElementById('btnReset').addEventListener('click', resetAnimation);
        
        document.getElementById('scaleSlider').addEventListener('input', (e) => {
            exaggeratedScale = parseInt(e.target.value);
            drawStructure(animProgress);
        });

        document.getElementById('nextStep').addEventListener('click', () => {
            if (currentStep < totalSteps - 1) {
                currentStep++;
                updateStepUI();
                if (currentStep === 4 && animProgress === 0) animateDrop();
            }
        });

        document.getElementById('prevStep').addEventListener('click', () => {
            if (currentStep > 0) {
                currentStep--;
                updateStepUI();
                if (currentStep < 4) resetAnimation();
            }
        });

        window.onload = function() {
            resizeCanvas();
            drawStructure(0);
            updateStepUI();
        };
    </script>
</body>
</html>
